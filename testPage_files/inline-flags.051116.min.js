var fTimer,vContent=$("meta[name=viewport]").attr("content"),$win=-1!=navigator.platform.indexOf("Win"),$cr=-1!=navigator.platform.indexOf("CrOS"),sr="pick a reason";
function flagpost(c,g,b){if(!editing){editing=1;var d=!1;-1!=navigator.platform.indexOf("iPhone")||-1!=navigator.platform.indexOf("iPad")||(d="ontouchstart"in document.documentElement?!0:!1);for(var e=document.getElementById("flag"+b+c);e.hasChildNodes();)e.removeChild(e.firstChild);var a=[],f=[];1==b||3==b||5==b||7==b||8==b||10==b||19==b||21==b||23==b?(a[1]="pick a reason to flag:",f[1]="pick a reason",a[2]="fantastic post",f[2]="fantastic post",a[3]="double post",f[3]="double post",a[4]="HTML/display error",f[4]="display error",a[5]="offensive/sexism/racism",f[5]="offensive/sexism/racism",a[6]="it breaks the guidelines",f[6]="breaks guidelines",a[7]="flag with note...",f[7]="flag with note..."):(a[1]="pick a reason to flag:",f[1]="pick a reason",a[2]="fantastic comment",f[2]="fantastic comment",a[3]="HTML/display error",f[3]="display error",a[4]="offensive/sexism/racism",f[4]="offensive/sexism/racism",a[6]="noise/derail/other",f[6]="noise",a[5]="it breaks the guidelines",f[5]="breaks guidelines",a[7]="flag with note...",f[7]="flag with note...");var h=document.createElement("select");h.id="reason"+b+c;h.name="badpost_reason";h.font="7px";h.className="flagdrop";!$win&&!$cr&&(h.onchange=function(){this.onblur="";fTimer=setTimeout(function(){sendFlag(c,g,b)},200)});d||(h.onblur=function(){cancelFlag(c,g,b);return false});for(d=1;d<a.length;++d){var i=document.createElement("option");i.text=a[d];i.value=f[d];h.options[h.length]=i}e.appendChild(h);if($win||$cr)$("#flag"+b+c).on("keydown mouseup","#reason"+b+c,function(a){var d=a.keyCode||a.which;if(d==9||d==13||d==1||d==0){a.preventDefault();a=$("#reason"+b+c).val();if(a!==sr&&a!=="pick a reason"){this.onblur="";sr=a;fTimer=setTimeout(function(){sendFlag(c,g,b)},200)}}});a=document.createElement("a");a.href="#";a.style.fontWeight="normal";a.target="_self";a.title="cancel";a.className="flag";a.innerHTML="x";a.onclick=function(){cancelFlag(c,g,b);return false};e.appendChild(document.createTextNode(" "));e.appendChild(document.createTextNode("["));e.appendChild(a);e.appendChild(document.createTextNode("]"));dezoomify();document.getElementById("reason"+b+c).focus()}return!1}
function cancelFlag(c,g,b){clearTimeout(fTimer);$("#flagbox"+b+c).remove();rezoomify();var d=document.createElement("a");d.href="#";d.onclick=function(){flagpost(c,g,b);return!1};d.style.fontWeight="normal";d.target="_self";d.title="Flag this";d.className="flag";d.innerHTML="!";for(var e=document.getElementById("flag"+b+c);e.hasChildNodes();)e.removeChild(e.firstChild);e.appendChild(document.createTextNode("["));e.appendChild(d);e.appendChild(document.createTextNode("]"));editing=0;sr="pick a reason";return!1}
function sendNote(c,g,b){
	var d=$("#flagnote"+c+g).val(),
		b=b+"&badpost_note="+encodeURIComponent(d);
	"undefined"==typeof jQuery?alert("The page is still loading, please wait to flag."):jQuery.post("//"+subd+".metafilter.com/contribute/flag_ajax.cfm",b,setFlag(g,c)).fail(function(data){console.debug(data)})}
function sendFlag(c,g,b){
	var d=[,"mefi","mefi_comment","ask","ask_comment","metatalk","metatalk_comment","projects","music","music_comment","jobs",,,"projects_comment",,,,,,"irl","irl_comment","exlibris","exlibris_comment","fanfare","fanfare_comment"],
		e=document.getElementById("reason"+b+c),
		a=e.options[e.selectedIndex].value;
	e.blur();
	d="badpost_id="+c+"&badpost_type="+d[b];
	c!=g&&(d=d+"&parent_id="+g);
	d=d+"&badpost_reason="+escape(a);
	if("flag with note..."==a&&!$("#flagbox"+b+c).length){
		rezoomify()
		e=$('<div class="flagbox" id="flagbox'+b+c+'">Flag Reason:<br><textarea class="flagnote" id="flagnote'+b+c+'"></textarea><br><input type="button" class="button" value="Add Note" onclick="sendNote('+b+","+c+",'"+d+'\');">&nbsp;&nbsp;or&nbsp;&nbsp;<input type="button" class="redbutton" value="Cancel" onclick="cancelFlag('+c+","+g+","+b+');"></div>')
		$("#flag"+b+c).parent().after(e)
		$("#flagnote"+b+c).focus()
		console.debug($('#flagnote'+b+c))
		$('#flagnote'+b+c).keyup(function(ev){
			if(ev.key === 'Escape'){
				cancelFlag(c, g, b)
			}
		})
	} else {
		if("undefined"==typeof jQuery){
			alert("The page is still loading, please wait to flag.")
		} else {
			jQuery.post("//"+subd+".metafilter.com/contribute/flag_ajax.cfm",d,setFlag(c,b))
		}
	}
}
function setFlag(c,g){$("#flagbox"+g+c).remove();
					  for(c=document.getElementById("flag"+g+c);c.hasChildNodes();)c.removeChild(c.firstChild);c.appendChild(document.createTextNode("[Flagged]"));editing=0;sr="pick a reason"}
function dezoomify(){$iPh&&($("meta[name=viewport]").remove(),$("head").append('<meta name="viewport" content="'+vContent.replace(/, user-scalable=\d/,"")+', user-scalable=0">'))}
function rezoomify(){$iPh&&($("meta[name=viewport]").remove(),$("head").append('<meta name="viewport" content="'+vContent.replace(/, user-scalable=\d/,"")+', user-scalable=1">'))};
